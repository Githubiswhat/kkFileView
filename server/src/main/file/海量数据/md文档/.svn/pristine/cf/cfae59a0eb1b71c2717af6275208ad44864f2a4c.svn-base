#### pg_zhtrgm插件

**功能描述**

创建扩展pg_zhtrgm，其主要作用是做相似度匹配，可以简化全文索引的使用方式，并且该扩展不仅支持对英文字符全文检索，还允许对中文字符进行全文检索。

**注意事项**

- 用户需要在当前数据库中具有create权限，即可在当前数据库创建插件pg_zhtrgm。

- 若未使用安装程序安装Vastbase，为自己初始化实例，initdb时指定的 -E 和--locale参数对应的编码规则必须一致，否则将无法使用pg_zhtrgm插件。

**操作说明**

此类全文索引仅支持模糊查询，不支持等值匹配。对应的操作符如下所示：

| **操作符**     | **返回类型** | **描述**                                                     |
| -------------- | ------------ | ------------------------------------------------------------ |
| text ％ text   | boolean      | 如果其参数的相似度大于pg_trgm.similarity_threshold设置的当前相似度阈值，则返回true。 |
| text <％ text  | boolean      | 如果第一个参数的子集与第二个参数的有序集合的相似程度大于系统设定值，则返回true。当前的相似性阈值通过pg_trgm.word_similarity_threshold参数设定。 |
| text ％> text  | boolean      | <％运算符的换向器。                                          |
| text <-> text  | real         | 返回参数之间的“距离”，即1减去similarity()值。                |
| text <<-> text | real         | 返回参数之间的“距离”，即1减去word_similarity()值。           |
| text <->> text | real         | <<->运算符的换向器。                                         |

pg_zhgrtm支持使用函数。对应的函数如下所示

| **函数**              | **返回类型** | **描述**                                                     |
| --------------------- | ------------ | ------------------------------------------------------------ |
| similarity(text,text) | real         | 返回一个数字指示两个参数有多相似。该结果的范围是0（指示两个字符串完全不相似）到1（指示两个字符串完全一样）。 |
| show_trgm(text)       | text         | 返回一个给定字符串中所有的trigram组成的一个数组（实际上除了调试很少有用）。 |
| show_limit()          | real         | 返回%操作符使用的当前相似性阈值。                            |
| set_limit(real)       | real         | 设置%操作符使用的当前相似性阈值。                            |

**示例**

1、创建插件

```
create extension pg_zhtrgm;
```

2、创建中文数据表如下：

```
create table t_full_text(id int, info text);
insert into t_full_text values (1, ' Vastbase是一种特性非常齐全的自由软件的对象-关系型数据库管理系统（ORDBMS），Vastbase支持大部分的SQL标准并且提供了很多其他现代特性，如复杂查询、外键、触发器、视图、事务完整性、多版本并发控制等。同样，PostgreSQL也可以用许多方法扩展，例如通过增加新的数据类型、函数、操作符、聚集函数、索引方法、过程语言等。另外，因为许可证的灵活，任何人都可以以任何目的免费使用、修改和分发PostgreSQL。');
```

3、在此表上创建以pg_zhgrtm提供的gin_zhtrgm_ops、gist_zhtrgm_ops操作符类所支持的gin索引或gist索引，该索引创建不再需要借助to_tsvector函数，同样地，使用该索引进行查询时也不再需要借助to_tsquery函数。

```
create index idx_full_text1 on t_full_text using gin(info gin_zhtrgm_ops);
create index idx_full_text2 on t_full_text using gist(info gist_zhtrgm_ops);
```

4、可以进行单字、词语、条件、短句的全文搜索：

- 使用单字搜索。

```
select * from t_full_text where info like '%函%';
```

结果显示如下：

```
 id |                                                                                                                                                                                
           info                                                                                                                                                                                          
----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------
  1 |  Vastbase是一种特性非常齐全的自由软件的对象-关系型数据库管理系统（ORDBMS），Vastbase支持大部分的SQL标准并且提供了很多其他现代特性，如复杂查询、外键、触发器、视图、事务完整性、多
版本并发控制等。同样，PostgreSQL也可以用许多方法扩展，例如通过增加新的数据类型、函数、操作符、聚集函数、索引方法、过程语言等。另外，因为许可证的灵活，任何人都可以以任何目的免费使用、
改和分发PostgreSQL。
(1 row)
```

- 使用词语搜索。

```
select * from t_full_text where info like '%视图%';
```

结果显示如下：

```
 id |                                                                                                                                                                                  
           info                                                                                                                                                                                            
----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------
  1 |  Vastbase是一种特性非常齐全的自由软件的对象-关系型数据库管理系统（ORDBMS），Vastbase支持大部分的SQL标准并且提供了很多其他现代特性，如复杂查询、外键、触发器、视图、事务完整性、多
版本并发控制等。同样，PostgreSQL也可以用许多方法扩展，例如通过增加新的数据类型、函数、操作符、聚集函数、索引方法、过程语言等。另外，因为许可证的灵活，任何人都可以以任何目的免费使用、
改和分发PostgreSQL。
(1 row)
```

- not like条件搜索。

```
select * from t_full_text where info like '%查询%' and info not like '%外键%';
```

结果显示如下：

```
 id | info 
----+------
(0 rows)
```

- 使用语句搜索

```
select * from t_full_text where info like '%Vastbase是一种特性非常齐全的自由软件的对象%';
```

结果显示如下：

```
 id |                                                                                                                                                                                  
           info                                                                                                                                                                                          
----+----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
----------------------
  1 |  Vastbase是一种特性非常齐全的自由软件的对象-关系型数据库管理系统（ORDBMS），Vastbase支持大部分的SQL标准并且提供了很多其他现代特性，如复杂查询、外键、触发器、视图、事务完整性、多
版本并发控制等。同样，PostgreSQL也可以用许多方法扩展，例如通过增加新的数据类型、函数、操作符、聚集函数、索引方法、过程语言等。另外，因为许可证的灵活，任何人都可以以任何目的免费使用、
改和分发PostgreSQL。
(1 row)
```

